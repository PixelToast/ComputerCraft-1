-- CraftOS+ by Sirharry0077

-- Variables
OSversion = "5.1"
noconnection = "true"
version = "recommended"
newVersion = 0
skip = "false"
-- Get Variable
if fs.exists("bin/latest") == true then
 file = fs.open("bin/latest", "r")
 text = file.readLine()
 file.close()
 if text == "true" then
  version = "latest"
 end
else
 version = "recommended"
end
rootFolder = "https://raw.github.com/Sirharry0077/ComputerCraft/master/"..version.."/"

-- Functions

function openRednet()
 x = 1
 repeat
  if x == 1 then
   side = "right"
  elseif x == 2 then
   side = "left"
  elseif x == 3 then
   side = "top"
  elseif x == 4 then
   side = "bottom"
  elseif x == 5 then
   side = "back"
  end
  if rednet.isOpen(side) == nil then
   rednet.open(side)
  end
  x = x + 1
 until x == 6
end

function download(url, path)
 http.request(url)
 local requesting = true
 while requesting do
  local event, url, sourceText = os.pullEvent()
  if event == "http_success" then
   local respondedText = sourceText.readAll()
   requesting = false
   local getFile = http.get(url)
   local text = getFile.readAll()
   getFile.close()
   file = fs.open(path, "w")
   file.write(text)
   file.close()
   success = true
  elseif event == "http_failure" then
   requesting = false
   success = false
  end
 end
end

function setServerID()
 file = fs.open("bin/server", "r")
 serverid = file.readLine()
 file.close()
 serverid = tonumber(serverid)
end

function checkNewerVersion()
 download(rootFolder.."programs/version", "bin/version")
 file = fs.open("bin/version", "r")
 newVersion = file.readLine()
 file.close()
 fs.delete("bin/version")
 if success == false then
  newVersion = "0"
 end
 vnumber = tonumber(OSversion)
 newvnumber = tonumber(newVersion)
 if newvnumber > vnumber then
  shell.run("clear")
  print("Update ", newversion, " Available")
  print("---------------------")
  download(rootFolder.."programs/changelog", "bin/changelog")
  file = fs.open("bin/changelog", "r")
  changelog = file.readAll()
  file.close()
  if success == false then
   print("Did Not Receive Change Log")
  else
   print("Change Log: ")
   print(changelog)
  end
  write("Update Y/N?: ")
  answer = read()
  shell.run("clear")
  if answer == "y" then
   shell.run("install")
  elseif answer == "n" then
   print("Loading...")
  elseif answer == "Y" then
   shell.run("install")
  elseif answer == "N" then
   print("Loading...")
  else
   print("Unrecognized Answer")
   print("Update Canceled")
   sleep(2)
  end  
 end
end

function testServerConnection()
 rednet.send(serverid, "testconnection")
 id, connection = rednet.receive(3)
 if id == nil then
  noconnection = "true"
 elseif id == serverid then
  noconnection = "false"
 end
end

local function checkFirstTime()
 if fs.exists("bin") == false then
  print("Welcome To CraftOS+")
  print("-------------------")
  print("Just Press ENTER To Proceed")
  read()
  shell.run("clear")
 end

  if fs.exists("bin/server") == false then
  print("Choose Server")
  print("-------------")
  print("This Is The ID of The Server That You Would Like To Use")
  print("The ID Must Be A Number")
  write("Server: ")
  newserver = read()
  fs.makeDir("bin")
  file = fs.open("bin/server", "w")
  file.write(newserver)
  file.close()
  shell.run("clear")
 end
 
 if fs.exists("bin/username") == false then
  print("Create Username")
  print("---------------")
  write("Username: ")
  newusername = read()
  fs.makeDir("bin")
  file = fs.open("bin/username", "w")
  file.write(newusername)
  file.close()
  shell.run("clear")
 end

 if fs.exists("bin/password") == false then
  print("Create Password")
  print("---------------")
  write("Password: ")
  newpassword = read("*")
  fs.makeDir("bin")
  file = fs.open("bin/password", "w")
  file.write(newpassword)
  file.close()
  shell.run("clear")
 end
end

function fetchComputerID()
computerid = os.computerID()
end

function screenClear()
  shell.run("clear")
  print("CraftOS+ ", OSversion)
  print("------------")
end

function writeLoginSreen() 
 shell.run("clear")
 term.setCursorPos(1, 1)
 print("Computer #", computerid)
 term.setCursorPos(20, 6)
 print("CraftOS+ ", OSversion)
 term.setCursorPos(20, 7)
 print("------------")
 term.setCursorPos(16, 8)
 print("Username: ")
 term.setCursorPos(16, 9)
 print("Password: ")
 term.setCursorPos(1, 1)
 if noconnection == "true" then
  print("No Server Connection")
 end

 term.setCursorPos(26, 8)
 file = fs.open("bin/username", "r")
 user = file.readLine()
 file.close()
 print(user)

 term.setCursorPos(26, 9)
 file = fs.open("bin/password", "r")
 pass = file.readLine()
 file.close()
 if read("*") == pass then
  screenClear()
 else
  writeLoginSreen()
 end
end

local function setComputerLabel()
 file = fs.open("bin/username", "r")
 user = file.readLine()
 file.close()
 cid = os.getComputerID()
 label = user.."'s Computer | ID "..cid
 os.setComputerLabel(label)
end

function commandUpload()
 shell.run("clear")
 print("Upload To Server")
 print("----------------")
 write("File: ")
 filename = read()
 if fs.exists(filename) == false then
  print("File Doesn't Exist")
  sleep(2)
  commandUpload()
  return
 end
 write("Destination: ")
 destination = read()
 file = fs.open(filename, "r")
 filetext = file.readAll()
 file.close()
 rednet.send(serverid, "upload")
 sleep(1)
 rednet.send(serverid, destination)
 sleep(1)
 rednet.send(serverid, filetext)
 id, msg = rednet.receive(5)
 if msg == "success" then
  print("Upload Successful")
 elseif id == nil then
  print("No Server Response")
 else
  print("Upload Unsuccessful")
 end
 sleep(2)
 screenClear()
end

function commandDownload()
 shell.run("clear")
 print("Download")
 print("--------")
 write("File: ")
 filename = read()
 write("Location: ")
 filename2 = read()
 rednet.send(serverid, "download")
 sleep(1)
 rednet.send(serverid, filename2)
 id, filetext = rednet.receive(5)
 if id == serverid and id ~= nil then
  print("File Received")
  file = fs.open(filename, "w")
  file.write(filetext)
  file.close()
 else
  print("No Server Response")
 end
 sleep(2)
 screenClear()
end

function stopServer()
 shell.run("clear")
 print("Stopping Server...")
 print("------------------")
 rednet.send(serverid, "stop")
 id, msg = rednet.receive(5)
 if msg == "stopped" then
  print("Server Stopped")
 elseif id == nil then
  print("No Server Response")
 end
 sleep(2)
 screenClear()
end

-- Code
openRednet()
shell.run("clear")
oldpullEvent = os.pullEvent
os.pullEvent = os.pullEventRaw

print("Loading...")
checkFirstTime()

if fs.exists("bin/skipStartup") == true then
 file = fs.open("bin/skipStartup", "r")
 skip = file.readLine()
 file.close()
 fs.delete("bin/skipStartup")
end
if version == "recommended" then
 checkNewerVersion()
elseif version == "latest" and skip == "false" then
 download(rootFolder.."programs/installer", "installer")
 shell.run("installer")
 read()
 fs.delete("bin/skipStartup")
 fs.delete("installer")
 file = fs.open("bin/skipStartup", "w")
 file.write("true")
 file.close()
 os.reboot()
end

setServerID()
testServerConnection()
fetchComputerID()
setComputerLabel()
writeLoginSreen()
screenClear()

-- Read Entrie and Do Appropiate Action
arguments = {}
invalidcommands = {}
fail = false
while true do
 oldpullEvent = os.pullEvent
 os.pullEvent = os.pullEventRaw
 
 write("> ")
 local command = read()
 for match in string.gmatch(command, "[^ \t]+") do
   table.insert( arguments, match )
 end
 
 for i,v in ipairs(invalidcommands) do
  if arguments[1] == v then
   print("Invalid command.")
   sleep(1)
   fail = true
  end
 end
 
 if not fail then
  if arguments[1] == "clear" then
   clearSreen()
  elseif arguments[1] == "upload" then
   commandUpload()
  elseif arguments[1] == "download" then
   commandDownload()
  elseif arguments[1] == "firewolf" then
   shell.run("firewolf")
   screenClear()
   openRednet()
  elseif arguments[1] == "stop" then
   stopServer()
  else
   if arguments[3] == nil then
    if arguments[2] == nil then
     shell.run(arguments[1])
    else
     shell.run(arguments[1], arguments[2])
    end
   else
    shell.run(arguments[1], arguments[2], arguments[3])
   end
  end
 end
 fail = false
 arguments = {}
 
 os.pullEvent = oldpullEvent
end